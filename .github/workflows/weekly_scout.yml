
name: Weekly Product Scout

on:
  schedule:
    # 每周一上午 8:00 (UTC) 运行。你可以根据需要修改 CRON 表达式。
    # 格式: 分 时 日 月 周
    - cron: '0 8 * * 1'
  workflow_dispatch: # 允许手动点击按钮触发测试

permissions:
  contents: write # 必须有写入权限才能保存 history.json

jobs:
  scout-and-email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run Scout Agent
        env:
          # 这些变量需要在 GitHub 仓库的 Settings -> Secrets 中配置
          API_KEY: ${{ secrets.API_KEY }}
          EMAIL_SERVICE_ID: ${{ secrets.EMAIL_SERVICE_ID }}
          EMAIL_TEMPLATE_ID: ${{ secrets.EMAIL_TEMPLATE_ID }}
          EMAIL_PUBLIC_KEY: ${{ secrets.EMAIL_PUBLIC_KEY }}
          EMAIL_PRIVATE_KEY: ${{ secrets.EMAIL_PRIVATE_KEY }} # 新增私钥
        run: node server/weekly_task.mjs

      - name: Commit and Push History
        # 只有当 history.json 发生变化时才提交
        run: |
          git config --global user.name 'Amazon Scout Bot'
          git config --global user.email 'bot@noreply.github.com'
          git add server/history.json
          # 检查是否有变更，如果有则提交
          git diff --quiet && git diff --staged --quiet || (git commit -m "update: scout history [skip ci]" && git push)

